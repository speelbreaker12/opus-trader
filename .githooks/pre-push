#!/usr/bin/env bash
set -euo pipefail

VERIFY_SH_PATH="${VERIFY_SH_PATH:-./plans/verify.sh}"
if [[ ! -x "$VERIFY_SH_PATH" ]]; then
  echo "ERROR: verify script not found or not executable: $VERIFY_SH_PATH" >&2
  exit 1
fi

if [[ "${SKIP_PRE_PUSH_VERIFY:-0}" == "1" ]]; then
  echo "WARN: SKIP_PRE_PUSH_VERIFY=1, skipping verification"
  exit 0
fi

while read -r _local_ref _local_sha remote_ref _remote_sha; do
  if [[ "$remote_ref" == "refs/heads/main" || "$remote_ref" == "refs/heads/master" ]]; then
    echo "Pushing to protected branch: $remote_ref"
    if [[ -z "${CI:-}" && "${VERIFY_ALLOW_LOCAL_FULL:-0}" != "1" ]]; then
      echo "WARN: local full verify disabled; running quick and relying on CI"
      "$VERIFY_SH_PATH" quick
      continue
    fi
    "$VERIFY_SH_PATH" full
  else
    echo "Pushing to feature branch: $remote_ref"
    "$VERIFY_SH_PATH" quick
  fi
done

