# PR Postmortem (Agent-Filled)

> ARCHIVAL NOTE (Legacy Workflow): This postmortem contains historical references to removed Ralph/workflow-acceptance components. Treat these references as archival context only.

## 0) One-line outcome
- Outcome: Added conditional workflow acceptance in verify, added workflow_verify helper, and consolidated WF-2.8/WF-2.9 map entries.
- Contract/plan requirement satisfied: WF-5.5 workflow acceptance policy; WF-12.8 traceability gate.
- Workstream (Ralph Loop workflow | Stoic Trader bot): Ralph Loop workflow
- Contract used (specs/WORKFLOW_CONTRACT.md | CONTRACT.md): specs/WORKFLOW_CONTRACT.md

## 1) Constraint (TOC)
- Constraint encountered: workflow_acceptance cost on every verify slowed workflow maintenance.
- Exploit (what I did now): gate workflow acceptance on workflow file changes + add workflow_verify for focused maintenance runs.
- Subordinate (workflow changes needed): run workflow_contract_gate earlier when map/contract changes to surface duplicates before acceptance.
- Elevate (permanent fix proposal): add a verify-time gate that runs workflow_contract_gate when workflow-critical files change.

## 2) Evidence & Proof
- Critical MUSTs touched (CR-IDs or contract anchors): WF-5.5, WF-11.1, WF-11.2, WF-12.8.
- Proof (tests/commands + outputs): See commands below.
  - `bash -n plans/verify.sh plans/workflow_verify.sh plans/workflow_acceptance.sh` -> exit 0.
  - `./plans/workflow_contract_gate.sh` -> `workflow contract gate: OK`.
  - `./plans/workflow_acceptance.sh` -> `Workflow acceptance tests passed`.
  - `./plans/verify.sh full` -> `VERIFY OK (mode=full)`; `✓ workflow acceptance passed`. Artifacts: `artifacts/verify/20260116_174658/`.

## 3) Guesses / Assumptions
- Assumption -> Where it should be proven -> Validated? (Y/N): See items below.
- Workflow acceptance policy uses WORKFLOW_ACCEPTANCE_POLICY (auto|always|never) -> specs/WORKFLOW_CONTRACT.md §5.5 -> Y.
- Consolidating WF-2.8/WF-2.9 map entries is acceptable -> plans/workflow_contract_gate.sh -> Y.

## 4) Friction Log
- Top 3 time/token sinks:
  1) workflow_acceptance runtime.
  2) full verify (cargo test/clippy).
  3) traceability gate failure on duplicate WF ids.

## 5) Failure modes hit
- Repro steps + fix + prevention check/test: See failure details below.
  - Failure: workflow_acceptance Test 12 failed due to duplicate WF-2.8/WF-2.9 in map.
  - Repro: `./plans/workflow_acceptance.sh`.
  - Fix: merge duplicate WF-2.8/WF-2.9 entries in plans/workflow_contract_map.json.
  - Prevention: run `./plans/workflow_contract_gate.sh` when map/contract changes; keep Test 12.

## 6) Conflict & Change Zoning
- Files/sections changed: plans/verify.sh; plans/workflow_acceptance.sh; plans/workflow_verify.sh; plans/workflow_contract_map.json; specs/WORKFLOW_CONTRACT.md; reviews/postmortems/2026-01-17-elev-001-002.md; plans/progress.txt; docs/contract_coverage.md.
- Hot zones discovered: plans/verify.sh workflow gating; plans/workflow_acceptance.sh acceptance assertions; plans/workflow_contract_map.json mapping block.
- What next agent should avoid / coordinate on: coordinate changes in verify/acceptance/map to avoid traceability gate breaks.

## 7) Reuse
- Patterns/templates created (prompts, scripts, snippets): plans/workflow_verify.sh local maintenance runner.
- New "skill" to add/update: none.
- How to apply it (so it compounds): run ./plans/workflow_verify.sh for workflow maintenance work.

## 8) What should we add to AGENTS.md?
- Propose 1–3 bullets max.
- Each bullet must be actionable (MUST/SHOULD), local (one rule, one reason), and enforceable (script/test/checklist).
- Include: Trigger condition, failure mode prevented, and where to enforce.
1)
- Rule: MUST run ./plans/workflow_contract_gate.sh when editing specs/WORKFLOW_CONTRACT.md or plans/workflow_contract_map.json.
- Trigger: any change to workflow contract or map files.
- Prevents: duplicate/missing WF ids breaking traceability gates.
- Enforce: plans/verify.sh preflight gate or PR checklist.
2)
- Rule: SHOULD run ./plans/workflow_verify.sh for workflow maintenance work.
- Trigger: edits to workflow/harness files (per plans/verify.sh:is_workflow_file).
- Prevents: missing workflow acceptance or syntax checks.
- Enforce: AGENTS.md checklist + plans/workflow_acceptance.sh assertions.

## 9) Concrete Elevation Plan to reduce Top 3 sinks
- Provide 1 Elevation + 2 subordinate cheap wins.
- Each must include Owner, Effort (S/M/L), Expected gain, Proof of completion.
- Must directly reduce the Top 3 sinks listed above.
- Must include one automation (script/check) if possible.

### Elevate (permanent fix)
- Change: run plans/workflow_contract_gate.sh inside plans/verify.sh when workflow-critical files change.
- Owner: workflow maintainer
- Effort: S
- Expected gain: earlier detection of map/contract drift, fewer acceptance reruns.
- Proof of completion: verify logs show workflow_contract_gate gate and it fails on duplicate WF ids.

### Subordinate (cheap wins)
1)
- Change: add workflow_verify usage note to AGENTS.md for workflow maintenance.
- Owner: workflow maintainer
- Effort: S
- Expected gain: fewer missed acceptance runs.
- Proof of completion: AGENTS.md contains the rule and is referenced in PR template.

2)
- Change: document ./plans/workflow_verify.sh in plans/README.md.
- Owner: workflow maintainer
- Effort: S
- Expected gain: faster onboarding for workflow maintenance.
- Proof of completion: plans/README.md includes workflow_verify usage.

## 10) Enforcement Path (Required if recurring)
- Recurring issue? (Y/N): N
- Enforcement type (script_check | contract_clarification | test | none): none
- Enforcement target (path added/updated in this PR): N/A
- WORKFLOW_FRICTION.md updated? (Y/N): N

## 11) Apply or it didn't happen
- What new invariant did we just discover?: Workflow acceptance must be conditional on workflow file changes locally and always on in CI.
- What is the cheapest automated check that enforces it?: plans/workflow_acceptance.sh assertions for should_run_workflow_acceptance + skip message.
- Where is the canonical place this rule belongs? (contract | plan | AGENTS | SKILLS | script): contract
- What would break if we remove your fix?: workflow acceptance would run on every verify or be skipped incorrectly, hurting throughput or coverage.
