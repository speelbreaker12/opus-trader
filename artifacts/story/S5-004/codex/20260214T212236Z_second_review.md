# Codex review

- Story: S5-004
- Timestamp (UTC): 20260214T212236Z
- Branch: story/S5-004/fma-guards
- HEAD: 8899d6fa7aef0f1c6a1a76aff96ddb8a5a454837
- Mode: failure-mode-analysis
- Review scope: Fixes 5-7 (reject reason codes, TLSM validation, VecDeque)

---

## Findings

### Fix 5: Reject reason codes (MEDIUM)
- 3 new RejectReasonCode variants: FeeCacheStale, WalAppendFailed, RiskStateDegraded
- 3 mapping changes in reject_reason_from_chokepoint documented with changelog comment
- Old variants retained — no backward compatibility break
- Registry test updated with 3 new minimum tokens
- test_intent_pipeline.rs assertion updated from MarginHeadroomRejectOpens to RiskStateDegraded
- **Verdict: PASS** — semantic accuracy improved, no compatibility breaks

### Fix 6: TLSM validation in WAL ledger (HIGH)
- TlsState::is_valid_successor() whitelist derived from Tlsm::apply() match arms
- Includes out-of-order paths (AT-210 Created→Filled, AT-230 Sent→Filled)
- IllegalTransition error variant added to LedgerAppendError
- update_state() validates transition before applying
- Cross-crate sync test (test_tlsm_wal_whitelist_sync) verifies all Tlsm transitions are allowed by WAL whitelist
- **Verdict: PASS** — state-level whitelist is conservative, sync test is exhaustive

### Fix 7: VecDeque optimization (LOW)
- pending_breaches changed from Vec to VecDeque
- remove(0) → pop_front() for O(1) front removal
- drain_breaches() uses Vec::from(std::mem::take(&mut self.pending_breaches))
- No behavioral change, pure performance improvement
- **Verdict: PASS** — drop-in replacement, no functional impact

## Summary
- Blocking: 0
- Major: 0
- Medium: 0
