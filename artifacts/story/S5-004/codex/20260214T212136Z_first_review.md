# Codex review

- Story: S5-004
- Timestamp (UTC): 20260214T212136Z
- Branch: story/S5-004/fma-guards
- HEAD: 8899d6fa7aef0f1c6a1a76aff96ddb8a5a454837
- Mode: failure-mode-analysis
- Review scope: Fixes 1-4 (GateResults default, quantize overflow, config validation, fee rate validation)

---

## Findings

### Fix 1: GateResults default (CRITICAL)
- Default changed from all-true (fail-open) to all-false (fail-closed) via #[derive(Default)]
- 59 test call sites migrated to gate_results_all_passing() helper in tests/common/mod.rs
- Architectural test at test_dispatch_chokepoint.rs scans for struct literals in src/ — unaffected by default() change
- No production code uses GateResults::default() — all construction is explicit
- **Verdict: PASS** — fail-closed is correct, test migration is complete

### Fix 2: Quantize overflow (HIGH)
- quantize_ratio_to_i64 now returns Result with finite/overflow guards
- raw_qty < 0.0 rejected in quantize() — zero allowed per existing test
- Negative price NOT rejected — existing tests exercise negative price rounding
- 7 new tests cover NaN, Inf, NEG_INFINITY, overflow ratio, negative qty, zero qty, NaN price
- **Verdict: PASS** — all overflow paths guarded, existing behavior preserved

### Fix 3: Config validation (HIGH)
- resolve_config_value rejects non-finite and negative values
- Uses existing MissingConfigError type with descriptive reason field
- Zero is allowed (some thresholds legitimately use 0)
- 7 new tests: NaN, Inf, NEG_INFINITY, negative, zero, positive, none-with-default
- **Verdict: PASS** — blanket non-negative policy is justified by Appendix A analysis

### Fix 4: Fee rate validation (MEDIUM)
- Early return for invalid fee_rate: HardStale + Degraded + fee_rate_effective=0.0
- Invalid buffer falls back to 0.0 (conservative)
- Zero fee_rate tests added for fresh and soft-stale scenarios
- **Verdict: PASS** — fail-closed behavior correct, NaN propagation prevented

## Summary
- Blocking: 0
- Major: 0
- Medium: 0
