name: CI

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, edited]
  push:
    branches: [ main ]
  schedule:
    # 19:00 America/Managua (UTC-6)
    - cron: "0 1 * * *"

jobs:
  pr-template-lint:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Lint PR template sections
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_DRAFT: ${{ github.event.pull_request.draft }}
          PR_TEMPLATE_LINT_DRAFT_MODE: warn
        run: |
          mode="strict"
          if [[ "${PR_DRAFT}" == "true" && "${PR_TEMPLATE_LINT_DRAFT_MODE}" != "strict" ]]; then
            mode="warn"
          fi

          printf '%s' "${PR_BODY:-}" > pr_body.md

          set +e
          python3 tools/ci/lint_pr_template_sections.py --body-file pr_body.md --mode "$mode" | tee pr_template_lint.log
          rc=${PIPESTATUS[0]}
          set -e

          if [[ -s pr_template_lint.log ]]; then
            while IFS= read -r line; do
              [[ -z "$line" ]] && continue
              if [[ "$mode" == "warn" ]]; then
                echo "::warning::$line"
              elif [[ "$rc" -ne 0 ]]; then
                echo "::error::$line"
              fi
            done < pr_template_lint.log
          fi

          if [[ "$mode" == "warn" ]]; then
            echo "PR template lint ran in warn mode for draft PR."
            exit 0
          fi
          exit "$rc"

  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # required for BASE_REF diff gate

      - name: SSOT lint
        run: bash plans/ssot_lint.sh

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python tools
        run: |
          python -m pip install --upgrade pip
          pip install ruff pytest mypy pyyaml jsonschema

      - name: Contract profile tags
        run: python tools/ci/check_contract_profiles.py --contract specs/CONTRACT.md

      - name: Contract kernel hash check
        run: |
          if [ -f docs/contract_kernel.json ]; then
            python scripts/check_contract_kernel.py
          else
            echo "No contract kernel found; skipping"
          fi

      - name: CSP Trace Validation
        run: |
          # Check if any CSP clause was modified
          if git diff origin/main -- specs/CONTRACT.md | grep -qE '<!-- CSP-[0-9]{3} -->'; then
            echo "CSP clause changed - running strict validation"
            python scripts/check_csp_trace.py --strict
          else
            python scripts/check_csp_trace.py
          fi

      - name: Contract Change Impact Report
        run: |
          mkdir -p artifacts
          python scripts/generate_impact_report.py --json > artifacts/impact_report.json || true
          python scripts/generate_impact_report.py

      - name: Upload Impact Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: impact-report
          path: artifacts/impact_report.json
          if-no-files-found: ignore

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Node deps (if present)
        shell: bash
        run: |
          if [ -f pnpm-lock.yaml ]; then
            corepack enable
            pnpm install --frozen-lockfile
          elif [ -f package-lock.json ]; then
            npm ci
          elif [ -f yarn.lock ]; then
            corepack enable
            yarn install --frozen-lockfile
          else
            echo "No JS lockfile; skipping node install"
          fi

      - name: Verify (single source of truth)
        id: verify
        env:
          CI_GATES_SOURCE: verify
          BASE_REF: origin/main
          VERIFY_CONSOLE: verbose
        run: |
          chmod +x ./plans/verify.sh
          ./plans/verify.sh full 2>&1 | tee verify_output.log
        continue-on-error: true

      - name: Parse verify output for annotations
        if: always()
        run: |
          # Convert verify.sh failures to GitHub annotations
          if [ -f verify_output.log ]; then
            # Extract FAIL lines and convert to annotations
            grep -n "FAIL:" verify_output.log | while read -r line; do
              line_num=$(echo "$line" | cut -d: -f1)
              message=$(echo "$line" | cut -d: -f2- | sed 's/^ *//')
              echo "::error file=plans/verify.sh,line=1::$message"
            done

            # Extract error lines from test output
            grep -nE "^error\[|FAILED|panicked at" verify_output.log | head -20 | while read -r line; do
              message=$(echo "$line" | cut -d: -f2- | sed 's/^ *//')
              echo "::error::$message"
            done

            # Extract warnings
            grep -n "WARN:" verify_output.log | while read -r line; do
              message=$(echo "$line" | cut -d: -f2- | sed 's/^ *//')
              echo "::warning::$message"
            done
          fi

      - name: Upload verify log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: verify-log
          path: verify_output.log
          if-no-files-found: ignore

      - name: Check verify result
        if: steps.verify.outcome == 'failure'
        run: |
          echo "::error::verify.sh failed - see annotations above and verify-log artifact"
          exit 1
