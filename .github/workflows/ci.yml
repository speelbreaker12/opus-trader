name: CI

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, edited]
  push:
    branches: [ main ]
  schedule:
    - cron: "0 1 * * *"

jobs:
  pr-template-lint:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Lint PR template sections
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_DRAFT: ${{ github.event.pull_request.draft }}
          PR_TEMPLATE_LINT_DRAFT_MODE: warn
        run: |
          mode="strict"
          if [[ "${PR_DRAFT}" == "true" && "${PR_TEMPLATE_LINT_DRAFT_MODE}" != "strict" ]]; then
            mode="warn"
          fi

          printf '%s' "${PR_BODY:-}" > pr_body.md

          set +e
          python3 tools/ci/lint_pr_template_sections.py --body-file pr_body.md --mode "$mode" | tee pr_template_lint.log
          rc=${PIPESTATUS[0]}
          set -e

          if [[ -s pr_template_lint.log ]]; then
            while IFS= read -r line; do
              [[ -z "$line" ]] && continue
              if [[ "$mode" == "warn" ]]; then
                echo "::warning::$line"
              elif [[ "$rc" -ne 0 ]]; then
                echo "::error::$line"
              fi
            done < pr_template_lint.log
          fi

          if [[ "$mode" == "warn" ]]; then
            echo "PR template lint ran in warn mode for draft PR."
            exit 0
          fi
          exit "$rc"

  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python tools
        run: |
          python -m pip install --upgrade pip
          pip install ruff pytest mypy pyyaml jsonschema

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Node deps (if present)
        shell: bash
        run: |
          if [ -f pnpm-lock.yaml ]; then
            corepack enable
            pnpm install --frozen-lockfile
          elif [ -f package-lock.json ]; then
            npm ci
          elif [ -f yarn.lock ]; then
            corepack enable
            yarn install --frozen-lockfile
          else
            echo "No JS lockfile; skipping node install"
          fi

      - name: Verify (single source of truth)
        env:
          BASE_REF: origin/main
          VERIFY_CONSOLE: verbose
        run: |
          chmod +x ./plans/verify.sh ./plans/verify_fork.sh
          ./plans/verify.sh full 2>&1 | tee verify_output.log

      - name: Upload verify log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: verify-log
          path: verify_output.log
          if-no-files-found: ignore
