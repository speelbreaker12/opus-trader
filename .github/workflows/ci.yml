name: CI

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, edited]
  pull_request_review:
    types: [submitted, edited, dismissed]
  pull_request_review_comment:
    types: [created, edited]
  issue_comment:
    types: [created, edited]
  push:
    branches: [ main ]
  schedule:
    - cron: "0 1 * * *"

jobs:
  pr-gate-enforced:
    if: |
      github.event_name == 'pull_request' ||
      github.event_name == 'pull_request_review' ||
      github.event_name == 'pull_request_review_comment' ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      checks: read
    env:
      GH_TOKEN: ${{ github.token }}
      PR_NUMBER: ${{ github.event.pull_request.number || github.event.issue.number }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Enforce PR gate (Copilot + aftercare + no new bot comments)
        run: |
          pr_json="$(gh api "repos/${GITHUB_REPOSITORY}/pulls/${PR_NUMBER}")"
          head_ref="$(jq -r '.head.ref // empty' <<<"$pr_json")"
          if [[ -z "$head_ref" ]]; then
            echo "ERROR: unable to resolve PR head ref for PR #${PR_NUMBER}" >&2
            exit 1
          fi

          if [[ "$head_ref" =~ ^story/(S[0-9]+-[0-9]{3})(/[A-Za-z0-9._-]+)?$ ]]; then
            story_id="${BASH_REMATCH[1]}"
          elif [[ "$head_ref" =~ ^story/(S[0-9]+-[0-9]{3})-[A-Za-z0-9._-]+$ ]]; then
            story_id="${BASH_REMATCH[1]}"
          else
            echo "ERROR: PR head branch must match story/<STORY_ID>[/<slug>] or story/<STORY_ID>-<slug> (slash-free STORY_ID, e.g., S{slice}-{NNN}), got: $head_ref" >&2
            exit 1
          fi

          chmod +x ./plans/pr_gate.sh
          ./plans/pr_gate.sh \
            --pr "${PR_NUMBER}" \
            --story "${story_id}" \
            --wait \
            --timeout-secs 1800 \
            --poll-secs 20 \
            --bot-comments-mode block \
            --require-aftercare-ack \
            --require-copilot-review \
            --ignore-check-run-regex '^pr-gate-enforced$'

  copilot-signal:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Copilot signal check
        run: echo "copilot signal present"

  pr-template-lint:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Lint PR template sections
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_DRAFT: ${{ github.event.pull_request.draft }}
          PR_TEMPLATE_LINT_DRAFT_MODE: warn
        run: |
          mode="strict"
          if [[ "${PR_DRAFT}" == "true" && "${PR_TEMPLATE_LINT_DRAFT_MODE}" != "strict" ]]; then
            mode="warn"
          fi

          printf '%s' "${PR_BODY:-}" > pr_body.md

          set +e
          python3 tools/ci/lint_pr_template_sections.py --body-file pr_body.md --mode "$mode" | tee pr_template_lint.log
          rc=${PIPESTATUS[0]}
          set -e

          if [[ -s pr_template_lint.log ]]; then
            while IFS= read -r line; do
              [[ -z "$line" ]] && continue
              if [[ "$mode" == "warn" ]]; then
                echo "::warning::$line"
              elif [[ "$rc" -ne 0 ]]; then
                echo "::error::$line"
              fi
            done < pr_template_lint.log
          fi

          if [[ "$mode" == "warn" ]]; then
            echo "PR template lint ran in warn mode for draft PR."
            exit 0
          fi
          exit "$rc"

  crossref-gate:
    if: github.event_name == 'pull_request' || github.event_name == 'push' || github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps for crossref
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml jsonschema

      - name: Run crossref gate (report-mode burn-in, strict via sentinel)
        env:
          CROSSREF_ARTIFACTS_DIR: artifacts/verify/crossref_ci_${{ github.run_id }}
        run: |
          chmod +x ./plans/crossref_gate.sh
          strict_args=()
          if [[ -f plans/crossref_ci_strict ]]; then
            strict_args+=(--strict)
          fi
          ./plans/crossref_gate.sh --ci --artifacts-dir "$CROSSREF_ARTIFACTS_DIR" "${strict_args[@]}" 2>&1 | tee crossref_gate.log

      - name: Upload crossref gate log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: crossref-gate-log
          path: crossref_gate.log
          if-no-files-found: ignore

  verify:
    if: github.event_name == 'pull_request' || github.event_name == 'push' || github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python tools
        run: |
          python -m pip install --upgrade pip
          pip install ruff pytest mypy pyyaml jsonschema

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Node deps (if present)
        shell: bash
        run: |
          if [ -f pnpm-lock.yaml ]; then
            corepack enable
            pnpm install --frozen-lockfile
          elif [ -f package-lock.json ]; then
            npm ci
          elif [ -f yarn.lock ]; then
            corepack enable
            yarn install --frozen-lockfile
          else
            echo "No JS lockfile; skipping node install"
          fi

      - name: Verify (single source of truth)
        env:
          BASE_REF: origin/main
          VERIFY_CONSOLE: verbose
        run: |
          chmod +x ./plans/verify.sh ./plans/verify_fork.sh
          ./plans/verify.sh full 2>&1 | tee verify_output.log

      - name: Upload verify log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: verify-log
          path: verify_output.log
          if-no-files-found: ignore
